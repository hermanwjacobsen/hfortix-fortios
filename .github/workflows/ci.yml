---
name: CI

'on':
  push:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort

      - name: Check formatting with Black
        run: |
          black --check --line-length=79 \
            packages/core/hfortix_core \
            packages/fortios/hfortix_fortios \
            packages/meta/hfortix

      - name: Check import sorting with isort
        run: |
          isort --check-only --profile=black --line-length=79 \
            packages/core/hfortix_core \
            packages/fortios/hfortix_fortios \
            packages/meta/hfortix

      - name: Lint with flake8
        run: |
          # Uses .flake8 config file (79 chars, ignores E501 for api/* folders)
          flake8 packages/core/hfortix_core packages/fortios/hfortix_fortios packages/meta/hfortix --statistics

  type-check:
    name: Type Checking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy httpx

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy packages/core/hfortix_core packages/fortios/hfortix_fortios packages/meta/hfortix \
            --ignore-missing-imports \
            --no-strict-optional \
            --no-warn-unreachable \
            --no-warn-return-any \
            --allow-untyped-defs \
            --allow-incomplete-defs \
            --exclude 'packages/fortios/hfortix_fortios/api/v2/'

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install "bandit[toml]"

      - name: Run bandit security scan
        run: |
          bandit -r \
            packages/core/hfortix_core \
            packages/fortios/hfortix_fortios \
            packages/meta/hfortix \
            -c pyproject.toml -f json -o bandit-report.json
          bandit -r \
            packages/core/hfortix_core \
            packages/fortios/hfortix_fortios \
            packages/meta/hfortix \
            -c pyproject.toml

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  # test:
  #   name: Test Suite
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       python-version: ['3.10', '3.11', '3.12']
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6
  #
  #   - name: Set up Python ${{ matrix.python-version }}
  #     uses: actions/setup-python@v6
  #     with:
  #       python-version: ${{ matrix.python-version }}
  #       cache: 'pip'
  #
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -e .[dev]
  #       pip install pytest pytest-cov pytest-asyncio
  #
  #   - name: Run unit tests
  #     run: |
  #       pytest tests/ -v -m unit --cov=hfortix --cov-report=xml
  #
  #   - name: Upload coverage to Codecov
  #     if: matrix.python-version == '3.10'
  #     uses: codecov/codecov-action@v4
  #     with:
  #       file: ./coverage.xml
  #       flags: unittests
  #       name: codecov-umbrella

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, type-check, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build distribution packages
        run: |
          cd packages/core && python -m build && cd ../..
          cd packages/fortios && python -m build && cd ../..
          cd packages/meta && python -m build && cd ../..
          mkdir -p dist
          cp packages/core/dist/* dist/ || true
          cp packages/fortios/dist/* dist/ || true
          cp packages/meta/dist/* dist/ || true

      - name: Check package with twine
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist-packages
          path: dist/
          retention-days: 7

  pre-commit-check:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit hooks
        run: |
          pre-commit run --all-files --show-diff-on-failure

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, type-check, security, build, pre-commit-check]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.pre-commit-check.result }}" != "success" ]]; then
            echo "❌ One or more checks failed"
            exit 1
          else
            echo "✅ All checks passed!"
          fi
