---
# ============================================================================
# PyPI Publishing Workflow - Multi-Package Support
# ============================================================================
# This workflow publishes HFortix packages to PyPI with support for:
# - Publishing all packages together (unified release)
# - Publishing individual packages (package-specific tags)
# - TestPyPI testing before production
# - Proper dependency ordering (core ‚Üí fortios ‚Üí meta)
#
# Package Structure:
# - hfortix-core: Core exceptions and HTTP client (no dependencies)
# - hfortix-fortios: FortiOS client (depends on hfortix-core)
# - hfortix: Meta-package (depends on hfortix-core, optional hfortix-fortios)
#
# Tag Formats:
# - v-core-X.Y.Z    ‚Üí Publish only hfortix-core
# - v-fortios-X.Y.Z ‚Üí Publish only hfortix-fortios (requires core published)
# - v-meta-X.Y.Z    ‚Üí Publish only hfortix meta-package
# - vX.Y.Z          ‚Üí Publish all packages (unified release)
#
# Publishing Flow:
# 1. Tag pushed matching pattern
# 2. Determine which packages to publish
# 3. Extract and validate versions
# 4. CI workflow runs (lint, type-check, security, build)
# 5. Wait for CI to pass
# 6. Publish to TestPyPI (validates packages)
# 7. Publish to PyPI (production) - ONLY if NOT a pre-release version
# 8. Create GitHub Release
#
# Pre-release Version Handling:
# - Versions containing 'dev', 'alpha', 'beta', or 'rc' are pre-releases
# - Pre-releases published to TestPyPI only
# - Pre-releases BLOCKED from production PyPI
# - GitHub releases marked as pre-release
#
# Authentication:
# - PyPI: Uses trusted publishing (OIDC, no token needed)
#   Configure at: https://pypi.org/manage/project/{package}/settings/publishing/
#   - hfortix-core
#   - hfortix-fortios
#   - hfortix
# ============================================================================
name: Publish to PyPI

'on':
  push:
    tags:
      - 'v-core-*'      # hfortix-core only
      - 'v-fortios-*'   # hfortix-fortios only
      - 'v-meta-*'      # hfortix meta-package only
      - 'v*.*.*'        # All packages (unified release)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Publish to PyPI or TestPyPI'
        required: true
        type: choice
        options:
          - pypi
          - testpypi
      packages:
        description: 'Packages to publish (comma-separated or "all")'
        required: false
        default: 'all'
        # Examples: "all", "core", "fortios", "meta", "core,fortios"

jobs:
  determine-packages:
    name: Determine Packages to Publish
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.parse.outputs.packages }}
      publish_core: ${{ steps.parse.outputs.publish_core }}
      publish_fortios: ${{ steps.parse.outputs.publish_fortios }}
      publish_meta: ${{ steps.parse.outputs.publish_meta }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse tag or input to determine packages
        id: parse
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag-based trigger
            TAG="${GITHUB_REF#refs/tags/}"
            echo "Tag: $TAG"

            if [[ "$TAG" =~ ^v-core- ]]; then
              echo "packages=core" >> $GITHUB_OUTPUT
              echo "publish_core=true" >> $GITHUB_OUTPUT
              echo "publish_fortios=false" >> $GITHUB_OUTPUT
              echo "publish_meta=false" >> $GITHUB_OUTPUT
              echo "üì¶ Publishing: hfortix-core only"
            elif [[ "$TAG" =~ ^v-fortios- ]]; then
              echo "packages=fortios" >> $GITHUB_OUTPUT
              echo "publish_core=false" >> $GITHUB_OUTPUT
              echo "publish_fortios=true" >> $GITHUB_OUTPUT
              echo "publish_meta=false" >> $GITHUB_OUTPUT
              echo "üì¶ Publishing: hfortix-fortios only"
            elif [[ "$TAG" =~ ^v-meta- ]]; then
              echo "packages=meta" >> $GITHUB_OUTPUT
              echo "publish_core=false" >> $GITHUB_OUTPUT
              echo "publish_fortios=false" >> $GITHUB_OUTPUT
              echo "publish_meta=true" >> $GITHUB_OUTPUT
              echo "üì¶ Publishing: hfortix meta-package only"
            elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "packages=all" >> $GITHUB_OUTPUT
              echo "publish_core=true" >> $GITHUB_OUTPUT
              echo "publish_fortios=true" >> $GITHUB_OUTPUT
              echo "publish_meta=true" >> $GITHUB_OUTPUT
              echo "üì¶ Publishing: ALL packages (unified release)"
            else
              echo "‚ùå Invalid tag format: $TAG"
              exit 1
            fi
          else
            # Manual workflow dispatch
            PACKAGES="${{ github.event.inputs.packages }}"
            if [[ "$PACKAGES" == "all" ]]; then
              echo "packages=all" >> $GITHUB_OUTPUT
              echo "publish_core=true" >> $GITHUB_OUTPUT
              echo "publish_fortios=true" >> $GITHUB_OUTPUT
              echo "publish_meta=true" >> $GITHUB_OUTPUT
            else
              echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
              if [[ "$PACKAGES" == *"core"* ]]; then
                echo "publish_core=true" >> $GITHUB_OUTPUT
              else
                echo "publish_core=false" >> $GITHUB_OUTPUT
              fi
              if [[ "$PACKAGES" == *"fortios"* ]]; then
                echo "publish_fortios=true" >> $GITHUB_OUTPUT
              else
                echo "publish_fortios=false" >> $GITHUB_OUTPUT
              fi
              if [[ "$PACKAGES" == *"meta"* ]]; then
                echo "publish_meta=true" >> $GITHUB_OUTPUT
              else
                echo "publish_meta=false" >> $GITHUB_OUTPUT
              fi
            fi
            echo "üì¶ Publishing: $PACKAGES"
          fi

  validate-versions:
    name: Validate Package Versions
    runs-on: ubuntu-latest
    needs: determine-packages
    outputs:
      core_version: ${{ steps.versions.outputs.core_version }}
      fortios_version: ${{ steps.versions.outputs.fortios_version }}
      meta_version: ${{ steps.versions.outputs.meta_version }}
      core_is_prerelease: ${{ steps.versions.outputs.core_is_prerelease }}
      fortios_is_prerelease: ${{ steps.versions.outputs.fortios_is_prerelease }}
      meta_is_prerelease: ${{ steps.versions.outputs.meta_is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Extract versions from pyproject.toml files
        id: versions
        run: |
          # Extract versions
          CORE_VERSION=$(grep '^version = ' packages/core/pyproject.toml | cut -d'"' -f2)
          FORTIOS_VERSION=$(grep '^version = ' packages/fortios/pyproject.toml | cut -d'"' -f2)
          META_VERSION=$(grep '^version = ' packages/meta/pyproject.toml | cut -d'"' -f2)

          echo "core_version=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "fortios_version=$FORTIOS_VERSION" >> $GITHUB_OUTPUT
          echo "meta_version=$META_VERSION" >> $GITHUB_OUTPUT

          echo "üì¶ Package Versions:"
          echo "   hfortix-core:    $CORE_VERSION"
          echo "   hfortix-fortios: $FORTIOS_VERSION"
          echo "   hfortix:         $META_VERSION"

          # Check for pre-release versions
          if [[ "$CORE_VERSION" =~ (dev|alpha|beta|rc) ]]; then
            echo "core_is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "core_is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          if [[ "$FORTIOS_VERSION" =~ (dev|alpha|beta|rc) ]]; then
            echo "fortios_is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "fortios_is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          if [[ "$META_VERSION" =~ (dev|alpha|beta|rc) ]]; then
            echo "meta_is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "meta_is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate dependency versions
        run: |
          CORE_VERSION="${{ steps.versions.outputs.core_version }}"
          FORTIOS_VERSION="${{ steps.versions.outputs.fortios_version }}"
          META_VERSION="${{ steps.versions.outputs.meta_version }}"

          # Check fortios depends on compatible core version
          FORTIOS_CORE_DEP=$(
            grep 'hfortix-core>=' packages/fortios/pyproject.toml |
            cut -d'"' -f2 | sed 's/hfortix-core>=//'
          )
          echo "hfortix-fortios requires: hfortix-core>=$FORTIOS_CORE_DEP"
          echo "hfortix-core version:     $CORE_VERSION"

          # Check meta depends on compatible core version
          META_CORE_DEP=$(
            grep 'hfortix-core>=' packages/meta/pyproject.toml |
            cut -d'"' -f2 | sed 's/hfortix-core>=//'
          )
          echo "hfortix requires:         hfortix-core>=$META_CORE_DEP"

          # Warning if versions mismatch (but don't fail - semver allows this)
          if [[ "$FORTIOS_CORE_DEP" != "$CORE_VERSION" ]] &&
             [[ "${{ needs.determine-packages.outputs.publish_fortios }}" == "true" ]]; then
            echo "‚ö†Ô∏è  WARNING: hfortix-fortios depends on core>=$FORTIOS_CORE_DEP but core is $CORE_VERSION"
          fi

  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions]
    strategy:
      matrix:
        include:
          - package: core
            path: packages/core
            pypi_name: hfortix-core
            publish: ${{ needs.determine-packages.outputs.publish_core }}
          - package: fortios
            path: packages/fortios
            pypi_name: hfortix-fortios
            publish: ${{ needs.determine-packages.outputs.publish_fortios }}
          - package: meta
            path: packages/meta
            pypi_name: hfortix
            publish: ${{ needs.determine-packages.outputs.publish_meta }}

    steps:
      - name: Checkout code
        if: matrix.publish == 'true'
        uses: actions/checkout@v6

      - name: Set up Python
        if: matrix.publish == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install build dependencies
        if: matrix.publish == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build ${{ matrix.pypi_name }}
        if: matrix.publish == 'true'
        run: |
          cd ${{ matrix.path }}
          python -m build
          ls -lh dist/

      - name: Check package with twine
        if: matrix.publish == 'true'
        run: |
          cd ${{ matrix.path }}
          twine check dist/*

      - name: Upload build artifacts
        if: matrix.publish == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.package }}
          path: ${{ matrix.path }}/dist/
          retention-days: 30

  # Wait for CI to pass before publishing
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'

    steps:
      - name: Wait for CI workflow to complete
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: All Checks Passed
          ref: ${{ github.sha }}
          timeoutSeconds: 1800  # 30 minutes max
          intervalSeconds: 10

  publish-testpypi-core:
    name: Publish hfortix-core to TestPyPI
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, build, wait-for-ci]
    if: |
      always() &&
      needs.determine-packages.outputs.publish_core == 'true' &&
      (needs.wait-for-ci.result == 'success' || needs.wait-for-ci.result == 'skipped') &&
      (github.event_name == 'push' || github.event.inputs.environment == 'testpypi')

    permissions:
      id-token: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-core
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Verify TestPyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.core_version }}"
          echo "‚è≥ Waiting 30s for TestPyPI to index hfortix-core $VERSION..."
          sleep 30
          pip index versions hfortix-core --index-url https://test.pypi.org/simple/ || true
          echo "‚úÖ hfortix-core published to TestPyPI"

  publish-testpypi-fortios:
    name: Publish hfortix-fortios to TestPyPI
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, build, wait-for-ci, publish-testpypi-core]
    if: |
      always() &&
      needs.determine-packages.outputs.publish_fortios == 'true' &&
      (needs.wait-for-ci.result == 'success' || needs.wait-for-ci.result == 'skipped') &&
      (needs.publish-testpypi-core.result == 'success' || needs.publish-testpypi-core.result == 'skipped') &&
      (github.event_name == 'push' || github.event.inputs.environment == 'testpypi')

    permissions:
      id-token: write

    steps:
      - name: Wait for core to be indexed
        if: needs.determine-packages.outputs.publish_core == 'true'
        run: |
          echo "‚è≥ Waiting 2 minutes for hfortix-core to be fully indexed..."
          sleep 120

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-fortios
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Verify TestPyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.fortios_version }}"
          echo "‚è≥ Waiting 30s for TestPyPI to index hfortix-fortios $VERSION..."
          sleep 30
          pip index versions hfortix-fortios --index-url https://test.pypi.org/simple/ || true
          echo "‚úÖ hfortix-fortios published to TestPyPI"

  publish-testpypi-meta:
    name: Publish hfortix to TestPyPI
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, build, wait-for-ci, publish-testpypi-core, publish-testpypi-fortios]
    if: |
      always() &&
      needs.determine-packages.outputs.publish_meta == 'true' &&
      (needs.wait-for-ci.result == 'success' || needs.wait-for-ci.result == 'skipped') &&
      (needs.publish-testpypi-fortios.result == 'success' || needs.publish-testpypi-fortios.result == 'skipped') &&
      (github.event_name == 'push' || github.event.inputs.environment == 'testpypi')

    permissions:
      id-token: write

    steps:
      - name: Wait for fortios to be indexed
        if: needs.determine-packages.outputs.publish_fortios == 'true'
        run: |
          echo "‚è≥ Waiting 2 minutes for hfortix-fortios to be fully indexed..."
          sleep 120

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-meta
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Verify TestPyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.meta_version }}"
          echo "‚è≥ Waiting 30s for TestPyPI to index hfortix $VERSION..."
          sleep 30
          pip index versions hfortix --index-url https://test.pypi.org/simple/ || true
          echo "‚úÖ hfortix published to TestPyPI"

  publish-pypi-core:
    name: Publish hfortix-core to PyPI
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, build, publish-testpypi-core]
    if: |
      always() &&
      needs.determine-packages.outputs.publish_core == 'true' &&
      needs.validate-versions.outputs.core_is_prerelease == 'false' &&
      needs.publish-testpypi-core.result == 'success' &&
      (github.event_name == 'push' || github.event.inputs.environment == 'pypi')
    environment:
      name: pypi-core
      url: https://pypi.org/project/hfortix-core/

    permissions:
      id-token: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-core
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Verify PyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.core_version }}"
          echo "‚è≥ Waiting 30s for PyPI to index hfortix-core $VERSION..."
          sleep 30
          pip index versions hfortix-core || true
          echo "‚úÖ hfortix-core $VERSION published to PyPI"

  publish-pypi-fortios:
    name: Publish hfortix-fortios to PyPI
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, build, publish-testpypi-fortios, publish-pypi-core]
    if: |
      always() &&
      needs.determine-packages.outputs.publish_fortios == 'true' &&
      needs.validate-versions.outputs.fortios_is_prerelease == 'false' &&
      needs.publish-testpypi-fortios.result == 'success' &&
      (needs.publish-pypi-core.result == 'success' || needs.publish-pypi-core.result == 'skipped') &&
      (github.event_name == 'push' || github.event.inputs.environment == 'pypi')
    environment:
      name: pypi-fortios
      url: https://pypi.org/project/hfortix-fortios/

    permissions:
      id-token: write

    steps:
      - name: Wait for core to be indexed
        if: needs.determine-packages.outputs.publish_core == 'true'
        run: |
          echo "‚è≥ Waiting 2 minutes for hfortix-core to be fully indexed on PyPI..."
          sleep 120

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-fortios
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Verify PyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.fortios_version }}"
          echo "‚è≥ Waiting 30s for PyPI to index hfortix-fortios $VERSION..."
          sleep 30
          pip index versions hfortix-fortios || true
          echo "‚úÖ hfortix-fortios $VERSION published to PyPI"

  publish-pypi-meta:
    name: Publish hfortix to PyPI
    runs-on: ubuntu-latest
    needs:
      - determine-packages
      - validate-versions
      - build
      - publish-testpypi-meta
      - publish-pypi-core
      - publish-pypi-fortios
    if: |
      always() &&
      needs.determine-packages.outputs.publish_meta == 'true' &&
      needs.validate-versions.outputs.meta_is_prerelease == 'false' &&
      needs.publish-testpypi-meta.result == 'success' &&
      (needs.publish-pypi-fortios.result == 'success' ||
       needs.publish-pypi-fortios.result == 'skipped') &&
      (github.event_name == 'push' ||
       github.event.inputs.environment == 'pypi')
    environment:
      name: pypi-meta
      url: https://pypi.org/project/hfortix/

    permissions:
      id-token: write

    steps:
      - name: Wait for fortios to be indexed
        if: needs.determine-packages.outputs.publish_fortios == 'true'
        run: |
          echo "‚è≥ Waiting 2 minutes for hfortix-fortios to be fully indexed on PyPI..."
          sleep 120

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-meta
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Verify PyPI publication
        run: |
          VERSION="${{ needs.validate-versions.outputs.meta_version }}"
          echo "‚è≥ Waiting 30s for PyPI to index hfortix $VERSION..."
          sleep 30
          pip index versions hfortix || true
          echo "‚úÖ hfortix $VERSION published to PyPI"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, publish-pypi-core, publish-pypi-fortios, publish-pypi-meta]
    if: |
      always() &&
      github.event_name == 'push' &&
      (needs.publish-pypi-core.result == 'success' ||
       needs.publish-pypi-fortios.result == 'success' ||
       needs.publish-pypi-meta.result == 'success' ||
       needs.validate-versions.outputs.core_is_prerelease == 'true' ||
       needs.validate-versions.outputs.fortios_is_prerelease == 'true' ||
       needs.validate-versions.outputs.meta_is_prerelease == 'true')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine release version and title
        id: release
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          if [[ "$TAG" =~ ^v-core- ]]; then
            VERSION="${{ needs.validate-versions.outputs.core_version }}"
            TITLE="hfortix-core $VERSION"
            IS_PRERELEASE="${{ needs.validate-versions.outputs.core_is_prerelease }}"
          elif [[ "$TAG" =~ ^v-fortios- ]]; then
            VERSION="${{ needs.validate-versions.outputs.fortios_version }}"
            TITLE="hfortix-fortios $VERSION"
            IS_PRERELEASE="${{ needs.validate-versions.outputs.fortios_is_prerelease }}"
          elif [[ "$TAG" =~ ^v-meta- ]]; then
            VERSION="${{ needs.validate-versions.outputs.meta_version }}"
            TITLE="hfortix $VERSION"
            IS_PRERELEASE="${{ needs.validate-versions.outputs.meta_is_prerelease }}"
          else
            # Unified release - use meta version
            VERSION="${{ needs.validate-versions.outputs.meta_version }}"
            TITLE="HFortix $VERSION"
            # Prerelease if ANY package is prerelease
            if [[ "${{ needs.validate-versions.outputs.core_is_prerelease }}" == "true" ]] || \
               [[ "${{ needs.validate-versions.outputs.fortios_is_prerelease }}" == "true" ]] || \
               [[ "${{ needs.validate-versions.outputs.meta_is_prerelease }}" == "true" ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          {
            echo "## Published Packages"
            echo ""
            if [[ "${{ needs.determine-packages.outputs.publish_core }}" == "true" ]]; then
              echo "- **hfortix-core** ${{ needs.validate-versions.outputs.core_version }}"
              echo "  - https://pypi.org/project/hfortix-core/${{ needs.validate-versions.outputs.core_version }}/"
            fi
            if [[ "${{ needs.determine-packages.outputs.publish_fortios }}" == "true" ]]; then
              echo "- **hfortix-fortios** ${{ needs.validate-versions.outputs.fortios_version }}"
              FORTIOS_URL="https://pypi.org/project/hfortix-fortios"
              echo "  - $FORTIOS_URL/${{ needs.validate-versions.outputs.fortios_version }}/"
            fi
            if [[ "${{ needs.determine-packages.outputs.publish_meta }}" == "true" ]]; then
              echo "- **hfortix** ${{ needs.validate-versions.outputs.meta_version }}"
              META_URL="https://pypi.org/project/hfortix"
              echo "  - $META_URL/${{ needs.validate-versions.outputs.meta_version }}/"
            fi
            echo ""
            echo "## Installation"
            echo ""
            echo "\`\`\`bash"
            echo "pip install hfortix[all]  # All packages"
            echo "pip install hfortix-fortios  # FortiOS + core"
            echo "pip install hfortix-core  # Core only"
            echo "\`\`\`"
            echo ""
            echo "See [CHANGELOG.md](CHANGELOG.md) for details."
          } > release-notes.md

          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release.outputs.title }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ steps.release.outputs.is_prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [determine-packages, validate-versions, publish-pypi-core, publish-pypi-fortios, publish-pypi-meta]
    if: |
      always() &&
      (needs.publish-pypi-core.result == 'success' ||
       needs.publish-pypi-fortios.result == 'success' ||
       needs.publish-pypi-meta.result == 'success')

    steps:
      - name: Success message
        run: |
          echo "üéâ Successfully published packages to PyPI!"
          echo ""
          if [[ "${{ needs.publish-pypi-core.result }}" == "success" ]]; then
            echo "‚úÖ hfortix-core ${{ needs.validate-versions.outputs.core_version }}"
            echo "   https://pypi.org/project/hfortix-core/${{ needs.validate-versions.outputs.core_version }}/"
          fi
          if [[ "${{ needs.publish-pypi-fortios.result }}" == "success" ]]; then
            echo "‚úÖ hfortix-fortios ${{ needs.validate-versions.outputs.fortios_version }}"
            echo "   https://pypi.org/project/hfortix-fortios/${{ needs.validate-versions.outputs.fortios_version }}/"
          fi
          if [[ "${{ needs.publish-pypi-meta.result }}" == "success" ]]; then
            echo "‚úÖ hfortix ${{ needs.validate-versions.outputs.meta_version }}"
            echo "   https://pypi.org/project/hfortix/${{ needs.validate-versions.outputs.meta_version }}/"
          fi

  notify-prerelease:
    name: Notify Pre-release
    runs-on: ubuntu-latest
    needs:
      - determine-packages
      - validate-versions
      - publish-testpypi-core
      - publish-testpypi-fortios
      - publish-testpypi-meta
    if: |
      always() &&
      (needs.validate-versions.outputs.core_is_prerelease == 'true' ||
       needs.validate-versions.outputs.fortios_is_prerelease == 'true' ||
       needs.validate-versions.outputs.meta_is_prerelease == 'true') &&
      (needs.publish-testpypi-core.result == 'success' ||
       needs.publish-testpypi-fortios.result == 'success' ||
       needs.publish-testpypi-meta.result == 'success')

    steps:
      - name: Pre-release message
        run: |
          echo "‚ö†Ô∏è  Pre-release versions detected - published to TestPyPI only"
          echo ""
          if [[ "${{ needs.publish-testpypi-core.result }}" == "success" ]]; then
            echo "‚úÖ hfortix-core ${{ needs.validate-versions.outputs.core_version }} (TestPyPI)"
          fi
          if [[ "${{ needs.publish-testpypi-fortios.result }}" == "success" ]]; then
            echo "‚úÖ hfortix-fortios ${{ needs.validate-versions.outputs.fortios_version }} (TestPyPI)"
          fi
          if [[ "${{ needs.publish-testpypi-meta.result }}" == "success" ]]; then
            echo "‚úÖ hfortix ${{ needs.validate-versions.outputs.meta_version }} (TestPyPI)"
          fi
          echo ""
          echo "‚ùå Production PyPI blocked (contains dev/alpha/beta/rc)"
