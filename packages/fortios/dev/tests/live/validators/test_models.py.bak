"""
Tests for hfortix_fortios models.

Tests FortiObject class and process_response function.
"""

from hfortix_fortios.models import FortiObject, process_response


# ============================================================================
# FortiObject basic tests
# ============================================================================

def test_forti_object_creation():
    """Test creating FortiObject from dict."""
    data = {"name": "test", "value": 123}
    obj = FortiObject(data)
    assert obj.name == "test"
    assert obj.value == 123
    print("✅ FortiObject - creation")


def test_forti_object_attribute_access():
    """Test attribute access on FortiObject."""
    data = {"policyid": 1, "name": "policy1", "action": "accept"}
    obj = FortiObject(data)
    assert obj.policyid == 1
    assert obj.name == "policy1"
    assert obj.action == "accept"
    print("✅ FortiObject - attribute access")


def test_forti_object_missing_attribute():
    """Test accessing non-existent attribute returns None."""
    obj = FortiObject({"name": "test"})
    assert obj.nonexistent is None
    print("✅ FortiObject - missing attribute returns None")


def test_forti_object_private_attribute_error():
    """Test accessing private attributes raises AttributeError."""
    obj = FortiObject({"name": "test"})
    try:
        _ = obj._private
        assert False, "Should have raised AttributeError"
    except AttributeError:
        pass
    print("✅ FortiObject - private attribute error")


# ============================================================================
# FortiObject member_table auto-wrapping tests
# ============================================================================

def test_forti_object_member_table_wrapping():
    """Test that member_table fields are auto-wrapped in FortiObject."""
    data = {
        "name": "policy1",
        "srcaddr": [{"name": "addr1"}, {"name": "addr2"}]
    }
    obj = FortiObject(data)
    srcaddr = obj.srcaddr
    
    assert isinstance(srcaddr, list)
    assert len(srcaddr) == 2
    assert isinstance(srcaddr[0], FortiObject)
    assert srcaddr[0].name == "addr1"
    assert srcaddr[1].name == "addr2"
    print("✅ FortiObject - member_table auto-wrapping")


def test_forti_object_get_full():
    """Test get_full returns raw data without processing."""
    data = {
        "name": "policy1",
        "srcaddr": [{"name": "addr1", "q_origin_key": "addr1"}]
    }
    obj = FortiObject(data)
    
    # get_full should return raw list of dicts
    raw = obj.get_full("srcaddr")
    assert isinstance(raw, list)
    assert isinstance(raw[0], dict)
    assert raw[0]["name"] == "addr1"
    assert raw[0]["q_origin_key"] == "addr1"
    print("✅ FortiObject - get_full")


def test_forti_object_to_dict():
    """Test to_dict returns original data."""
    data = {"name": "test", "value": 123}
    obj = FortiObject(data)
    result = obj.to_dict()
    assert result == data
    assert result is data  # Same object
    print("✅ FortiObject - to_dict")


def test_forti_object_json_property():
    """Test json property returns JSON string representation."""
    data = {"name": "test", "status": "success"}
    obj = FortiObject(data)
    assert isinstance(obj.json, str)
    assert '"name": "test"' in obj.json
    assert '"status": "success"' in obj.json
    print("✅ FortiObject - json property")


# ============================================================================
# FortiObject dict-like interface tests
# ============================================================================

def test_forti_object_contains():
    """Test 'in' operator."""
    obj = FortiObject({"name": "test", "value": 123})
    assert "name" in obj
    assert "value" in obj
    assert "nonexistent" not in obj
    print("✅ FortiObject - contains")


def test_forti_object_getitem():
    """Test bracket notation access."""
    obj = FortiObject({"name": "test", "srcaddr": [{"name": "addr1"}]})
    assert obj["name"] == "test"
    # Should also auto-wrap member_table
    assert isinstance(obj["srcaddr"][0], FortiObject)
    print("✅ FortiObject - getitem")


def test_forti_object_getitem_keyerror():
    """Test bracket notation raises KeyError for missing keys."""
    obj = FortiObject({"name": "test"})
    try:
        _ = obj["nonexistent"]
        assert False, "Should have raised KeyError"
    except KeyError:
        pass
    print("✅ FortiObject - getitem KeyError")


def test_forti_object_len():
    """Test len() returns number of fields."""
    obj = FortiObject({"a": 1, "b": 2, "c": 3})
    assert len(obj) == 3
    print("✅ FortiObject - len")


def test_forti_object_keys():
    """Test keys() method."""
    obj = FortiObject({"name": "test", "value": 123})
    keys = list(obj.keys())
    assert "name" in keys
    assert "value" in keys
    print("✅ FortiObject - keys")


def test_forti_object_values():
    """Test values() method (processed)."""
    obj = FortiObject({"name": "test", "members": [{"name": "m1"}]})
    values = list(obj.values())
    assert "test" in values
    # Members should be wrapped
    members = [v for v in values if isinstance(v, list)]
    assert len(members) == 1
    assert isinstance(members[0][0], FortiObject)
    print("✅ FortiObject - values")


def test_forti_object_items():
    """Test items() method (processed)."""
    obj = FortiObject({"name": "test", "value": 123})
    items = list(obj.items())
    assert ("name", "test") in items
    assert ("value", 123) in items
    print("✅ FortiObject - items")


def test_forti_object_get():
    """Test get() method with default."""
    obj = FortiObject({"name": "test"})
    assert obj.get("name") == "test"
    # get() returns None for non-existent attributes (doesn't support default for missing attrs)
    assert obj.get("nonexistent") is None
    # But for fields that exist with None value, it works
    obj2 = FortiObject({"name": "test", "comment": None})
    assert obj2.get("comment") is None
    print("✅ FortiObject - get")


# ============================================================================
# FortiObject repr and str tests
# ============================================================================

def test_forti_object_repr_complex():
    """Test repr for complex object."""
    obj = FortiObject({"name": "test", "value": 123, "status": "enable"})
    r = repr(obj)
    assert "FortiObject" in r
    assert "test" in r
    print("✅ FortiObject - repr complex")


def test_forti_object_repr_simple():
    """Test repr for simple member object (just name)."""
    obj = FortiObject({"name": "addr1"})
    r = repr(obj)
    assert r == "'addr1'"
    print("✅ FortiObject - repr simple")


def test_forti_object_repr_simple_with_qkey():
    """Test repr for simple member object with q_origin_key."""
    obj = FortiObject({"name": "addr1", "q_origin_key": "addr1"})
    r = repr(obj)
    assert r == "'addr1'"
    print("✅ FortiObject - repr simple with q_origin_key")


def test_forti_object_repr_policyid():
    """Test repr for object with policyid."""
    obj = FortiObject({"policyid": 1, "action": "accept"})
    r = repr(obj)
    assert "FortiObject" in r
    assert "1" in r
    print("✅ FortiObject - repr policyid")


def test_forti_object_repr_no_identifier():
    """Test repr for object without name or policyid."""
    obj = FortiObject({"a": 1, "b": 2, "c": 3})
    r = repr(obj)
    assert "FortiObject" in r
    assert "3 fields" in r
    print("✅ FortiObject - repr no identifier")


def test_forti_object_str():
    """Test str() representation."""
    obj = FortiObject({"name": "policy1", "action": "accept"})
    assert str(obj) == "policy1"
    print("✅ FortiObject - str")


def test_forti_object_str_policyid():
    """Test str() representation with policyid."""
    obj = FortiObject({"policyid": 1, "action": "accept"})
    assert str(obj) == "1"
    print("✅ FortiObject - str policyid")


# ============================================================================
# process_response tests
# ============================================================================

def test_process_response_list_to_objects():
    """process_response should wrap list of dicts into FortiObjects."""
    result = [{"name": "test1"}, {"name": "test2"}]
    processed = process_response(result)

    assert isinstance(processed, list)
    assert len(processed) == 2
    assert all(isinstance(p, FortiObject) for p in processed)
    assert [p.name for p in processed] == ["test1", "test2"]
    print("✅ process_response - list to FortiObjects")


def test_process_response_unwrap_single_list():
    """process_response with unwrap_single=True returns a single FortiObject."""
    result = [{"name": "test"}]
    processed = process_response(result, unwrap_single=True)

    assert isinstance(processed, FortiObject)
    assert processed.name == "test"
    print("✅ process_response - unwrap_single list")


def test_process_response_single_dict():
    """process_response with envelope dict extracts results."""
    # process_response expects envelope format with 'results' key
    envelope = {
        "http_status": 200,
        "status": "success",
        "results": {"name": "test", "status": "enable"}
    }
    processed = process_response(envelope)

    # When results is a single dict, returns FortiObject
    assert isinstance(processed, FortiObject)
    assert processed.name == "test"
    assert processed.status == "enable"
    print("✅ process_response - envelope with single dict result")


def test_process_response_default_mode():
    """process_response default mode (no unwrap_single) returns list of FortiObjects."""
    result = [{"name": "test"}]
    processed = process_response(result)

    assert isinstance(processed, list)
    assert len(processed) == 1
    assert isinstance(processed[0], FortiObject)
    assert processed[0].name == "test"
    print("✅ process_response - default mode list")


def test_process_response_other_type():
    """process_response with non-dict/list type should pass through."""
    result = "string result"
    processed = process_response(result)

    assert processed == "string result"
    print("✅ process_response - other type passthrough")


def run_all_tests():
    """Run all model tests."""
    print("\n" + "=" * 60)
    print("MODELS TESTS")
    print("=" * 60 + "\n")

    # FortiObject basic tests
    test_forti_object_creation()
    test_forti_object_attribute_access()
    test_forti_object_missing_attribute()
    test_forti_object_private_attribute_error()

    # FortiObject member_table tests
    test_forti_object_member_table_wrapping()
    test_forti_object_get_full()
    test_forti_object_to_dict()
    test_forti_object_json_property()

    # FortiObject dict-like interface tests
    test_forti_object_contains()
    test_forti_object_getitem()
    test_forti_object_getitem_keyerror()
    test_forti_object_len()
    test_forti_object_keys()
    test_forti_object_values()
    test_forti_object_items()
    test_forti_object_get()

    # FortiObject repr and str tests
    test_forti_object_repr_complex()
    test_forti_object_repr_simple()
    test_forti_object_repr_simple_with_qkey()
    test_forti_object_repr_policyid()
    test_forti_object_repr_no_identifier()
    test_forti_object_str()
    test_forti_object_str_policyid()

    # process_response tests
    test_process_response_list_to_objects()
    test_process_response_unwrap_single_list()
    test_process_response_single_dict()
    test_process_response_default_mode()
    test_process_response_other_type()

    print("\n" + "=" * 60)
    print("ALL MODELS TESTS PASSED!")
    print("=" * 60 + "\n")


if __name__ == "__main__":
    run_all_tests()
